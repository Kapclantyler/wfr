-- SettingsTab.lua v2.2 - Fixed
local SettingsTab = {}
local externalBindings = {}

local function createTabAfter(ui, title, icon, afterTab)
    local tab = ui:CreateTab(title, icon)
    return tab
end

function SettingsTab.Build(ui, afterTab, deps)
    local ConfigSystem = nil
    
    local attempts = 0
    while attempts < 10 do
        if ui._configManagerForSettings then
            ConfigSystem = ui._configManagerForSettings
            break
        elseif ui.configManager then
            ConfigSystem = ui.configManager
            break
        elseif deps and deps.ConfigSystem then
            ConfigSystem = deps.ConfigSystem
            break
        end
        attempts = attempts + 1
        if attempts < 10 then
            task.wait(0.05)
        end
    end
    
    if not ConfigSystem then
        warn("[SettingsTab] No ConfigSystem found!")
    end
    
    local tab = createTabAfter(ui, "Settings", "⚙️", afterTab)

    -- UI Settings Window
    local winKeys = tab:CreateWindow("UI Settings")
    
    winKeys:CreateKeybind("UI Toggle", "RightShift", function(key)
        ui:SetToggleKey(key)
    end)

    local watermarkCheckbox = winKeys:CreateCheckbox("Watermark", true, function(val)
        ui:SetWatermarkVisible(val)
    end)
    winKeys:CreateCheckbox("Show Keybind List", true, function(val)
        ui:SetKeybindListVisible(val)
    end)
    
    winKeys:CreateColorPicker("Theme Color", (ui.options and ui.options.theme and ui.options.theme.primary) or Color3.fromRGB(110,117,243), function(color, alpha)
        ui:SetTheme({ primary = color })
    end)
    
    -- Anti AFK
    local antiAfkEnabled = true
    local antiAfkConnection = nil
    
    local function startAntiAfk()
        if antiAfkConnection then
            antiAfkConnection:Disconnect()
        end
        
        local VirtualUser = game:GetService('VirtualUser')
        antiAfkConnection = game:GetService('Players').LocalPlayer.Idled:Connect(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end
    
    local function stopAntiAfk()
        if antiAfkConnection then
            antiAfkConnection:Disconnect()
            antiAfkConnection = nil
        end
    end
    
    winKeys:CreateCheckbox("Anti AFK", true, function(val)
        antiAfkEnabled = val
        if val then
            startAntiAfk()
        else
            stopAntiAfk()
        end
    end)
    
    -- FPS Boost
    winKeys:CreateButton("FPS Boost", function()
        local lighting = game:GetService("Lighting")
        local terrain = workspace:FindFirstChildOfClass('Terrain')
        
        lighting.GlobalShadows = false
        lighting.FogEnd = 9e9
        lighting.Brightness = 0
        
        for _, effect in pairs(lighting:GetChildren()) do
            if effect:IsA("PostEffect") then
                effect.Enabled = false
            end
        end
        
        if terrain then
            terrain.WaterWaveSize = 0
            terrain.WaterWaveSpeed = 0
            terrain.WaterReflectance = 0
            terrain.WaterTransparency = 0
        end
        
        settings().Rendering.QualityLevel = "Level01"
        
        for _, descendant in pairs(workspace:GetDescendants()) do
            if descendant:IsA("ParticleEmitter") or descendant:IsA("Trail") then
                descendant.Enabled = false
            elseif descendant:IsA("MeshPart") then
                descendant.Material = Enum.Material.Plastic
                descendant.Reflectance = 0
            end
        end
    end)
    
    startAntiAfk()

    -- Config Window
    local winCfg = tab:CreateWindow("Config")

    local cfgName = ""
    local configNameBox = winCfg:CreateTextBox("Config Name", "MyConfig", function(name)
        cfgName = name
    end)

    local configsDropdown = nil
    local selectedConfig = "Default"
    
    local function refreshDropdown(selectName)
        if not configsDropdown or not ConfigSystem then 
            return 
        end
        
        local list = {"Default"}
        
        if ConfigSystem then
            for attempt = 1, 3 do
                local newList = nil
                if ConfigSystem.getConfigList then
                    newList = ConfigSystem:getConfigList()
                elseif ConfigSystem.List then
                    newList = ConfigSystem.List()
                end
                
                if newList and #newList > 0 then
                    list = newList
                    break
                end
                
                if attempt < 3 then
                    task.wait(0.2)
                end
            end
        end
        
        if not table.find(list, "Default") then
            table.insert(list, 1, "Default")
        end
        
        if configsDropdown.SetOptions then 
            pcall(function() 
                configsDropdown.SetOptions(list) 
            end)
        end
        
        local choose = selectName or selectedConfig or "Default"
        
        if not table.find(list, choose) then
            choose = "Default"
        end
        
        if choose and configsDropdown.SetValue then 
            pcall(function() 
                configsDropdown.SetValue(choose) 
                selectedConfig = choose
            end)
        end
    end

    -- Create Config Button
    winCfg:CreateButton("Create Config", function()
        if not ConfigSystem or not cfgName or cfgName == '' then 
            return 
        end
        
        local alreadyExists = false
        if ConfigSystem.configExists then
            alreadyExists = ConfigSystem:configExists(cfgName)
        end
        
        if alreadyExists then
            return
        end
        
        local success = false
        if ConfigSystem.createConfig then
            success = ConfigSystem:createConfig(cfgName)
        end
        
        if success then
            task.spawn(function()
                task.wait(0.5)
                
                for attempt = 1, 5 do
                    refreshDropdown(cfgName)
                    
                    task.wait(0.2)
                    if selectedConfig == cfgName then
                        break
                    end
                end
                
                if configNameBox and configNameBox.SetValue then
                    configNameBox.SetValue("")
                    cfgName = ""
                end
            end)
        end
    end)

    -- Configs Dropdown
    local initialList = {"Default"}
    configsDropdown = winCfg:CreateDropdown("Configs", initialList, selectedConfig, function(val)
        selectedConfig = val
    end)
    
    -- Update dropdown list after initialization
    task.spawn(function()
        local attempts = 0
        while attempts < 20 do
            attempts = attempts + 1
            
            if ConfigSystem and (ConfigSystem.isInitialized == nil or ConfigSystem.isInitialized) then
                task.wait(0.5)
                refreshDropdown()
                break
            else
                task.wait(0.1)
            end
        end
    end)

    -- Load Button
    winCfg:CreateButton("Load", function()
        if not ConfigSystem or not selectedConfig then 
            return 
        end
        
        local success = false
        if ConfigSystem.loadConfig then
            success = ConfigSystem:loadConfig(selectedConfig)
        end
    end)

    -- Save Button
    winCfg:CreateButton("Save", function()
        if not ConfigSystem or not selectedConfig then 
            return 
        end
        
        local success = false
        if ConfigSystem.saveConfig then
            success = ConfigSystem:saveConfig(selectedConfig)
        end
        
        if success then
            task.defer(function() 
                refreshDropdown(selectedConfig) 
            end)
        end
    end)
    
    -- Delete Button
    winCfg:CreateButton("Delete", function()
        if not ConfigSystem or not selectedConfig then 
            return 
        end
        
        if string.lower(selectedConfig) == "default" then
            return
        end
        
        local success = false
        if ConfigSystem.deleteConfig then
            success = ConfigSystem:deleteConfig(selectedConfig)
        end
        
        if success then
            selectedConfig = nil
            
            task.defer(function()
                local list = {"Default"}
                if ConfigSystem.getConfigList then
                    list = ConfigSystem:getConfigList()
                end
                
                if configsDropdown then
                    configsDropdown.SetOptions(list)
                    configsDropdown.SetValue(list[1])
                    selectedConfig = list[1]
                end
            end)
        end
    end)

    -- Auto Load Checkbox
    local autoLoadCheckbox = winCfg:CreateCheckbox("Auto Load Config", false, function(val)
        if ConfigSystem then
            if ConfigSystem.setAutoLoad then
                ConfigSystem:setAutoLoad(val and selectedConfig or nil)
            end
        end
    end)

    -- Ensure default config exists
    if ConfigSystem then
        task.spawn(function()
            local attempts = 0
            while attempts < 15 do
                attempts = attempts + 1
                
                if ConfigSystem.isInitialized == nil or ConfigSystem.isInitialized then
                    local defaultExists = false
                    if ConfigSystem.configExists then
                        defaultExists = ConfigSystem:configExists('Default')
                    end
                    
                    if not defaultExists then
                        for createAttempt = 1, 3 do
                            local success = false
                            if ConfigSystem.createConfig then
                                success = ConfigSystem:createConfig('Default')
                            end
                            
                            if success then
                                task.wait(0.3)
                                if ConfigSystem:configExists('Default') then
                                    break
                                end
                            end
                            
                            if createAttempt < 3 then
                                task.wait(0.4)
                            end
                        end
                    end
                    
                    task.wait(0.3)
                    for refreshAttempt = 1, 3 do
                        refreshDropdown('Default')
                        task.wait(0.2)
                        
                        if selectedConfig == 'Default' then
                            break
                        end
                    end
                    
                    break
                else
                    task.wait(0.1)
                end
            end
        end)
    end

    return tab
end

function SettingsTab.RegisterBindings(map)
    if type(map) ~= 'table' then return end
    for k, v in pairs(map) do
        if type(k) == 'string' and type(v) == 'table' then
            externalBindings[k] = v
        end
    end
end

return SettingsTab
